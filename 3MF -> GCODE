#!/usr/bin/env python3
import os
import sys
import subprocess
from pathlib import Path

APP = ["flatpak", "run", "com.prusa3d.PrusaSlicer"]

# Set environment variables
os.environ["__NV_PRIME_RENDER_OFFLOAD"] = "1"
os.environ["__GLX_VENDOR_LIBRARY_NAME"] = "nvidia"

# Process all files passed to the script
for file_path in sys.argv[1:]:
    # Get absolute path
    absolute_path = Path(file_path).resolve()

    # Get the base filename without extension
    filename = absolute_path.with_suffix("")

    # Define output format and output file
    output_format = "bgcode"
    output_file = filename.with_suffix(f".{output_format}")

    # Run the application with the necessary flags
    subprocess.run(
        APP + ["-g", "--output", str(output_file), str(absolute_path)],
        check=False  # Set to True if you want it to raise an error on failure
    )